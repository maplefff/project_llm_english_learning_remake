<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡¨æ™‚æ¸¬é©—é é¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .question-area, .result-area, .navigation-area { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .question-area p, .result-area p { margin: 10px 0; }
        .passage { font-style: italic; color: #555; }
        .target-word { font-weight: bold; }
        .options label { display: block; margin-bottom: 8px; cursor: pointer; padding: 5px; border-radius: 3px; }
        .options label:hover { background-color: #f0f0f0; }
        .options input[type="radio"] { margin-right: 10px; }
        button { 
            display: block; 
            padding: 10px 15px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #nextQuestionBtn { background-color: #28a745; }
        #nextQuestionBtn:hover { background-color: #1e7e34; }
        .result-correct { color: green; font-weight: bold; }
        .result-incorrect { color: red; font-weight: bold; }
        .explanation { margin-top:10px; padding:10px; background-color:#e9ecef; border-left: 3px solid #007bff;}
        .error-message { color: red; font-weight: bold; margin-top: 15px; }
        .loading-message { color: #007bff; }
        #speakTargetWordBtn {
            background-color: #6c757d;
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 10px; /* èˆ‡ç›®æ¨™è©ç¨å¾®éš”é–‹ */
            vertical-align: middle; /* å‚ç›´å±…ä¸­å°é½Š */
        }
        #speakTargetWordBtn:hover {
            background-color: #5a6268;
        }

        /* ===== macOS æš—é»‘æ¨¡å¼æ”¯æ´ ===== */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #18191A;
                color: #E4E6EB;
            }
            .container {
                background-color: #242526;
                box-shadow: 0 0 16px rgba(0,0,0,0.6);
            }
            h1 {
                color: #E4E6EB;
            }
            .question-area, .result-area, .navigation-area {
                background-color: #242526;
                border: 1px solid #3A3B3C;
            }
            .passage {
                color: #B0B3B8;
            }
            .options label {
                background-color: #242526;
                color: #E4E6EB;
            }
            .options label:hover {
                background-color: #3A3B3C;
            }
            button {
                background-color: #3578E5;
                color: #F5F6FA;
            }
            button:hover {
                background-color: #2851A3;
            }
            button:disabled {
                background-color: #444950;
                color: #888;
            }
            #nextQuestionBtn {
                background-color: #44C767;
                color: #F5F6FA;
            }
            #nextQuestionBtn:hover {
                background-color: #388E3C;
            }
            .result-correct {
                color: #44C767;
            }
            .result-incorrect {
                color: #FF5C5C;
            }
            .explanation {
                background-color: #20232A;
                border-left: 3px solid #3578E5;
                color: #B0B3B8;
            }
            .error-message {
                color: #FF5C5C;
            }
            .loading-message {
                color: #3578E5;
            }
            #speakTargetWordBtn {
                background-color: #444950;
                color: #F5F6FA;
            }
            #speakTargetWordBtn:hover {
                background-color: #606770;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è©å½™æ¸¬é©— (é¡Œå‹ 1.1.1)</h1>

        <div id="loadingMessage" class="loading-message" style="display: none;">è¼‰å…¥ä¸­...</div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div class="question-area" id="questionDisplay" style="display: none;">
            <h2>é¡Œç›®</h2>
            <p class="passage"><strong>æ®µè½:</strong> <span id="passageText"></span></p>
            <p><strong>ç›®æ¨™è©:</strong> 
                <span id="targetWordText" class="target-word"></span>
                <button id="speakTargetWordBtn" title="ç™¼éŸ³">ğŸ”Š</button>
            </p>
            <p><strong>å•é¡Œ:</strong> <span id="questionText"></span></p>
            <div class="options" id="optionsContainer">
                <!-- é¸é …å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <button id="submitAnswerBtn">æäº¤ç­”æ¡ˆ</button>
        </div>

        <div class="result-area" id="resultDisplay" style="display: none;">
            <h2>ä½œç­”çµæœ</h2>
            <p id="submissionFeedback"></p>
            <p><strong>æ­£ç¢ºç­”æ¡ˆ:</strong> <span id="correctAnswerText"></span></p>
            <div class="explanation" id="explanationText" style="display: none;"></div>
        </div>

        <div class="navigation-area">
            <button id="nextQuestionBtn" style="display: none;">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3001/api'; // å¾Œç«¯ API çš„ URL (è«‹ç¢ºèªç«¯å£)
        let currentQuestionData = null; // å­˜å„²å¾Œç«¯è¿”å›çš„å®Œæ•´é¡Œç›®æ•¸æ“š
        let isLoading = false;

        const loadingMessageEl = document.getElementById('loadingMessage');
        const errorMessageEl = document.getElementById('errorMessage');
        const questionDisplayEl = document.getElementById('questionDisplay');
        const passageTextEl = document.getElementById('passageText');
        const targetWordTextEl = document.getElementById('targetWordText');
        const questionTextEl = document.getElementById('questionText');
        const optionsContainerEl = document.getElementById('optionsContainer');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        
        const resultDisplayEl = document.getElementById('resultDisplay');
        const submissionFeedbackEl = document.getElementById('submissionFeedback');
        const correctAnswerTextEl = document.getElementById('correctAnswerText');
        const explanationTextEl = document.getElementById('explanationText');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const speakTargetWordBtn = document.getElementById('speakTargetWordBtn');

        async function fetchAndRenderInitialQuestion() {
            showLoading(true);
            try {
                const response = await fetch(`${BASE_URL}/start-test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionType: '1.1.1' })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'ç„¡æ³•é–‹å§‹æ¸¬é©—ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹ã€‚' }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                currentQuestionData = await response.json();
                if (currentQuestionData && currentQuestionData.id) {
                    renderQuestion();
                    questionDisplayEl.style.display = 'block';
                } else {
                    showError('ç„¡æ³•ç²å–æœ‰æ•ˆé¡Œç›®ã€‚');
                }
            } catch (error) {
                console.error('Fetch initial question error:', error);
                showError(`ç²å–é¡Œç›®å¤±æ•—: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function renderQuestion() {
            if (!currentQuestionData) return;

            passageTextEl.innerHTML = currentQuestionData.passage; // ä½¿ç”¨ innerHTML ä»¥ä¾¿æ¸²æŸ“ <b>
            targetWordTextEl.textContent = currentQuestionData.targetWord;
            questionTextEl.textContent = currentQuestionData.question;
            
            optionsContainerEl.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …
            currentQuestionData.options.forEach(option => {
                const label = document.createElement('label');
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'answer';
                radio.value = option.id;
                radio.id = `option-${option.id}`;
                
                label.appendChild(radio);
                label.appendChild(document.createTextNode(` ${option.id}. ${option.text}`));
                optionsContainerEl.appendChild(label);
            });

            resultDisplayEl.style.display = 'none';
            explanationTextEl.style.display = 'none';
            submitAnswerBtn.style.display = 'block';
            submitAnswerBtn.disabled = false;
            nextQuestionBtn.style.display = 'none';
            clearError();
        }

        async function handleSubmitAnswer() {
            const selectedOption = optionsContainerEl.querySelector('input[name="answer"]:checked');
            if (!selectedOption) {
                showError('è«‹é¸æ“‡ä¸€å€‹ç­”æ¡ˆï¼');
                return;
            }
            if (isLoading || !currentQuestionData) return;

            showLoading(true);
            submitAnswerBtn.disabled = true;
            const userAnswer = selectedOption.value;

            try {
                const response = await fetch(`${BASE_URL}/submit-answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questionId: currentQuestionData.id,
                        userAnswer: userAnswer,
                        questionDataSnapshot: currentQuestionData 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'æäº¤ç­”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚' }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const resultData = await response.json();
                displaySubmissionResult(resultData.submissionResult);
                
                // æ›´æ–° currentQuestionData ç‚ºä¸‹ä¸€é¡Œ (å¦‚æœæœ‰çš„è©±)
                currentQuestionData = resultData.nextQuestion; 

                if (currentQuestionData && currentQuestionData.id) {
                    nextQuestionBtn.style.display = 'block';
                } else {
                    nextQuestionBtn.style.display = 'none';
                    submissionFeedbackEl.innerHTML += "<br>å·²æ˜¯æœ€å¾Œä¸€é¡Œæˆ–æ²’æœ‰æ›´å¤šé¡Œç›®äº†ã€‚";
                }
                submitAnswerBtn.style.display = 'none';

            } catch (error) {
                console.error('Submit answer error:', error);
                showError(`æäº¤ç­”æ¡ˆå¤±æ•—: ${error.message}`);
                submitAnswerBtn.disabled = false; // å…è¨±é‡è©¦
            } finally {
                showLoading(false);
            }
        }

        function displaySubmissionResult(submissionResult) {
            resultDisplayEl.style.display = 'block';
            if (submissionResult.isCorrect) {
                submissionFeedbackEl.textContent = 'å›ç­”æ­£ç¢ºï¼';
                submissionFeedbackEl.className = 'result-correct';
            } else {
                submissionFeedbackEl.textContent = 'å›ç­”éŒ¯èª¤ã€‚';
                submissionFeedbackEl.className = 'result-incorrect';
            }
            correctAnswerTextEl.textContent = submissionResult.correctAnswer;
            if (submissionResult.explanation) {
                explanationTextEl.innerHTML = submissionResult.explanation; // ä½¿ç”¨ innerHTML è™•ç†å¯èƒ½çš„æ ¼å¼
                explanationTextEl.style.display = 'block';
            } else {
                explanationTextEl.style.display = 'none';
            }
        }

        function handleNextQuestionClick() {
            if (currentQuestionData && currentQuestionData.id) {
                renderQuestion();
                questionDisplayEl.style.display = 'block';
            } else {
                showError("æ²’æœ‰ä¸‹ä¸€é¡Œäº†ã€‚");
                nextQuestionBtn.style.display = 'none';
                questionDisplayEl.style.display = 'none'; // éš±è—é¡Œç›®å€åŸŸ
                resultDisplayEl.style.display = 'none'; // éš±è—çµæœå€åŸŸ
            }
        }
        
        function showLoading(show) {
            isLoading = show;
            loadingMessageEl.style.display = show ? 'block' : 'none';
            if (show) clearError(); // è¼‰å…¥æ™‚æ¸…é™¤èˆŠéŒ¯èª¤
        }

        function showError(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.style.display = 'block';
        }
        function clearError() {
            errorMessageEl.textContent = '';
            errorMessageEl.style.display = 'none';
        }

        function speakText(textToSpeak) {
            if (!('speechSynthesis' in window) || !('SpeechSynthesisUtterance' in window)) {
                alert('æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æœ—è®€åŠŸèƒ½ã€‚');
                return;
            }
            // å¦‚æœå…ˆå‰æœ‰æ­£åœ¨æœ—è®€çš„å…§å®¹ï¼Œå…ˆå–æ¶ˆ
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US'; // è¨­å®šç‚ºç¾å¼è‹±èª
            utterance.rate = 0.9; // ç¨å¾®é™ä½èªé€Ÿï¼Œå¯ä»¥æ ¹æ“šéœ€è¦èª¿æ•´
            utterance.pitch = 1; // é è¨­éŸ³é«˜
            
            window.speechSynthesis.speak(utterance);
        }

        function handleSpeakTargetWordClick() {
            if (currentQuestionData && currentQuestionData.targetWord) {
                speakText(currentQuestionData.targetWord);
            }
        }

        // äº‹ä»¶ç›£è½
        submitAnswerBtn.addEventListener('click', handleSubmitAnswer);
        nextQuestionBtn.addEventListener('click', handleNextQuestionClick);
        speakTargetWordBtn.addEventListener('click', handleSpeakTargetWordClick);

        // é é¢è¼‰å…¥å®Œæˆå¾Œç²å–ç¬¬ä¸€é¡Œ
        document.addEventListener('DOMContentLoaded', fetchAndRenderInitialQuestion);
    </script>
</body>
</html> 